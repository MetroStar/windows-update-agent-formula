# Initialize wua dictionary with default data structure of relevant registry settings
# Registry key purposes are defined here, https://technet.microsoft.com/en-us/library/Dd939844(v=WS.10).aspx
# Formula supports all keys under these subkeys:
# - HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate
# - HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU

{%- set wua = {
    'hklm-windows-update' : {
        'AcceptTrustedPublisherCerts'   : {
            'name'  : 'HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate',
            'vtype' : 'REG_DWORD',
        },
        'DisableWindowsUpdateAccess'    : {
            'name'  : 'HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate',
            'vtype' : 'REG_DWORD',
        },
        'ElevateNonAdmins'              : {
            'name'  : 'HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate',
            'vtype' : 'REG_DWORD',
        },
        'TargetGroup'                   : {
            'name'  : 'HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate',
            'vtype' : 'REG_SZ',
        },
        'TargetGroupEnabled'            : {
            'name'  : 'HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate',
            'vtype' : 'REG_DWORD',
        },
        'WUServer'                      : {
            'name'  : 'HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate',
            'vtype' : 'REG_SZ',
        },
        'WUStatusServer'                : {
            'name'  : 'HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate',
            'vtype' : 'REG_SZ',
        },
    },
    'hkcu-explorer' : {
        'DisableWindowsUpdateAccess'    : {
            'name'  : 'HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer',
            'vtype' : 'REG_DWORD',
        },
    },
    'hklm-internet-communication'       : {
        'NoWindowsUpdate' : {
            'name'  : 'HKEY_LOCAL_MACHINE\\SYSTEM\\Internet Communication Management\\Internet Communication',
            'vtype' : 'REG_DWORD',
        },
    },
    'hkcu-windows-update' : {
        'DisableWindowsUpdateAccess'    : {
            'name'  : 'HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\WindowsUpdate',
            'vtype' : 'REG_DWORD',
        },
    },
    'hklm-windows-update-au' : {
        'AUOptions'                     : {
            'name'  : 'HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU',
            'vtype' : 'REG_DWORD',
        },
        'AutoInstallMinorUpdates'       : {
            'name'  : 'HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU',
            'vtype' : 'REG_DWORD',
        },
        'DetectionFrequency'            : {
            'name'  : 'HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU',
            'vtype' : 'REG_DWORD',
        },
        'DetectionFrequencyEnabled'     : {
            'name'  : 'HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU',
            'vtype' : 'REG_DWORD',
        },
        'NoAutoRebootWithLoggedOnUsers' : {
            'name'  : 'HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU',
            'vtype' : 'REG_DWORD',
        },
        'NoAutoUpdate'                  : {
            'name'  : 'HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU',
            'vtype' : 'REG_DWORD',
        },
        'RebootRelaunchTimeout'         : {
            'name'  : 'HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU',
            'vtype' : 'REG_DWORD',
        },
        'RebootRelaunchTimeoutEnabled'  : {
            'name'  : 'HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU',
            'vtype' : 'REG_DWORD',
        },
        'RebootWarningTimeout'          : {
            'name'  : 'HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU',
            'vtype' : 'REG_DWORD',
        },
        'RebootWarningTimeoutEnabled'   : {
            'name'  : 'HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU',
            'vtype' : 'REG_DWORD',
        },
        'RescheduleWaitTime'            : {
            'name'  : 'HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU',
            'vtype' : 'REG_DWORD',
        },
        'RescheduleWaitTimeEnabled'     : {
            'name'  : 'HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU',
            'vtype' : 'REG_DWORD',
        },
        'ScheduledInstallDay'           : {
            'name'  : 'HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU',
            'vtype' : 'REG_DWORD',
        },
        'ScheduledInstallTime'          : {
            'name'  : 'HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU',
            'vtype' : 'REG_DWORD',
        },
        'UseWUServer'                   : {
            'name'  : 'HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU',
            'vtype' : 'REG_DWORD',
        },
    },
} %}

# Loop through all keys in windows-update-agent pillar
# Select the corresponding key in `wua` and update its `vdata` subkey
{%- for subkey,keys in salt['pillar.get']('windows-update-agent:registry', {}).items() %}
    {%- for vname,vdata in keys.items() %}
        {%- do wua[subkey][vname].update({
            'vdata' : vdata
        }) %}
    {%- endfor %}
{%- endfor %}
